stages:
  - install
  - lint
  - build
  - test
  - deploy

# Cache node_modules Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ build
cache:
  paths:
    - node_modules/

variables:
  NODE_VERSION: "20"

# Stage 1: Install dependencies
install_dependencies:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - echo "ğŸ“¦ Installing dependencies..."
    - npm ci
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour
  only:
    - main
    - merge_requests

# Stage 2: Lint - Kiá»ƒm tra code quality
lint_code:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - echo "ğŸ” Running ESLint..."
    - npm run lint
  dependencies:
    - install_dependencies
  only:
    - main
    - merge_requests

# Stage 3: Build - Build production
build_production:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - echo "ğŸ—ï¸ Building production..."
    - npm run build
    - echo "âœ… Build completed successfully"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  dependencies:
    - install_dependencies
  only:
    - main


# Stage 5: Deploy - Deploy lÃªn server
deploy_production:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "ğŸš€ Deploying to production..."
    - echo "ğŸ“ Build artifacts ready in dist/ folder"
    - ls -la dist/
    # ThÃªm script deploy thá»±c táº¿ á»Ÿ Ä‘Ã¢y, vÃ­ dá»¥:
    # - scp -r dist/* user@server:/var/www/html/
    # - ssh user@server "sudo systemctl restart nginx"
    - echo "âœ… Deployment completed successfully!"
  dependencies:
    - build_production
  only:
    - main
  when: manual  # YÃªu cáº§u confirm thá»§ cÃ´ng trÆ°á»›c khi deploy
  environment:
    name: production
    url: https://your-domain.com

# Job Ä‘áº·c biá»‡t: Kiá»ƒm tra merge request
mr_validation:
  stage: lint
  image: node:${NODE_VERSION}
  script:
    - echo "âœ… Validating merge request..."
    - npm ci
    - npm run lint
    - echo "ğŸ” Checking for conflicts with main branch..."
    - git fetch origin main
    - git diff --check origin/main
  only:
    - merge_requests
  allow_failure: false
